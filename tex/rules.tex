\documentclass[10pt,a4paper]{article}
\usepackage[latin1]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{ngrammar}
\usepackage{ndisplay}
\usepackage{comment}
\usepackage[inference]{semantic}
\usepackage{liquidHaskell}
\usepackage{color}
\usepackage{textcomp}
\newcommand\highlight[2]{{\setlength\fboxsep{1pt}\colorbox{#1}{#2}}}
\def\NV{\highlight{colorNV}}
\definecolor{colorNV}{rgb}{1,0.8,1}


\newcommand\hastype[3]{\ensuremath{{#1} \vdash _{P,Q} #2 : #3}}
\newcommand\rulename[1]{\textsc{L}\textsc{#1}}
\newcommand\mlTy[1]{\ensuremath{\hat{#1}}}

\newcommand\mhide[1]{#1}
\newcommand\rhide[1]{}

\begin{document}
%\section*{Syntax}
%\subsection*{Types}
\include{grammar}
%\section*{Rules}
\include{typing}


%\subsection*{isWellFormedP}
\hfill\fbox{\isWellFormedP{\Gamma}{p}{e}}

$$
\inference{
	\hasType{\Gamma, v:\tau, \overline{x:\tau}}{}{e}{\tbool}
}{
	\isWellFormedP{\Gamma}{\pdVar{p}{\tau}{\overline{x:\tau}}}{e}
}[]
$$

%\subsection*{unifyTypes}
\hfill\fbox{\unifyTypes{\pdTy}{\dTy}{\dTy}}

$$
\inference{
	\unifyTypes{\pdTy}{\dTy}{\dTy'}
}{
	\unifyTypes{\pdTy}{\tforallPr{p}{\dTy}}{\tforallPr{p}{\dTy'}}
}[]
$$


$$
\inference{
	\unifyTypes{\pdTy}{\dTy}{\dTy'}
}{
	\unifyTypes{\tforallPr{p}{\pdTy}}{\dTy}{\tforallPr{p}{\dTy'}}
}[]
$$

$$
\inference{
	\unifyTypes{{\pdTy \subT{\alpha}{\alpha'}}}{{\dTy}}{\dTy'}
}{
	\unifyTypes	{\tforallTy{\alpha}{\pdTy}}
				{\tforallTy{\alpha'}{\dTy}}
				{\tforallTy{\alpha'}{\dTy'}}
}[]
$$

$$
\inference{
	\unifyTypes	{\pdTy_x}{\dTy_{x'}}{\dTy_x'} &
	\unifyTypes	{\pdTy \sub{x}{x'}}{\dTy_{x'}}{\dTy'}
}{
	\unifyTypes	{\tfun{x}{{\pdTy_x}}{\pdTy}}
				{\tfun{x'}{\dTy_{x'}}{\dTy}}
				{\tfun{x'}{\dTy_x'}{\dTy'}}
}[]
$$

$$
\inference{
}{
	\unifyTypes	{\tclass{\nhaskell{C}}{\listOf{\pdTy}}}
				{\tclass{\nhaskell{C}}{\listOf{\dTy}}}
				{\tclass{\nhaskell{C}}{\listOf{\dTy}}}
}[]
$$
$$
\inference{
}{
	\unifyTypes	{\tvar{\alpha}{P}} 
				{\tvar{\alpha}{e}}
				{\tvar{\alpha}{e \land \pdapp{P}{v}}}
}[]
$$
$$
\inference{
	\forall i . {\unifyTypes{\pdTy_i}{\dTy_i}{\dTy_i'}}
}{
	\unifyTypes	{\tcon{\nhaskell{C}}{P}{\listOf{\pdTy}}{\listOf{P}}}
				{\tcon{\nhaskell{C}}{e}{\listOf{\dTy}}{\listOf{e}}}
				{\tcon	{\nhaskell{C}}
						{e \land \pdapp{P}{v}}{\listOf{\dTy'}}
						{\listOf{e_i \land \pdapp{P_i}{v}}}
				}
}[]
$$

%\subsection*{\isWellFormedP{\Gamma}{p}{e}}
\hfill\fbox{\isWellFormedP{\Gamma}{p}{e}}

$$
\inference{
	\hasType{\Gamma, v:\tau, \listOf{x:\tau}}{}{e}{\tbool}
}{
	\isWellFormedP{\Gamma}{\pdVar{p}{\tau}{\listOf{x:\tau}}}{e}
}[]
$$

$$
\inference{
	\hasType{\Gamma}{}{e}{\tbool}
}{
	\isWellFormedP{\Gamma}{\pdTrue}{e}
}[]
$$

$$
\inference{
	\isWellFormedP{\Gamma}{P_1}{e_1} &
	\isWellFormedP{\Gamma}{P_2}{e_2}
}{
	\isWellFormedP{\Gamma}{\pdAnd{P_1}{P_2}}{e_1 \land e_2}
}[]
$$

%\subsection*{e \subP{p}{e}}
\hfill\fbox{e \subP{p}{e}}

\begin{align*}
(e_1 \land e_2) \subP{p}{e} &= (e_1 \subP{p}{e}) \land (e_1 \subP{p}{e})\\
(\pdapp{p}{v, \subP{\listOf{x}}{\listOf{y}}}) \subP{p}{e} &= e\subP{\listOf{x}}{\listOf{y}} \\
(e') \subP{p}{e} &= e'
\end{align*}

%\subsection*{e \pdapp{P}{v}}
\hfill\fbox{\pdapp{P}{v}}

\begin{align*}
\pdapp{\pdTrue}{v} &= \pdTrue \\
\pdapp{\pdVar{p}{\tau}{\listOf{\tau}}}{v} &= p(v) \\
\pdapp{\pdAnd{P_1}{P_2}}{v} &= {\pdapp{P_1}{v}}{\pdapp{P_2}{v}}
\end{align*}

%\subsection*{\dTy \subP{p}{e}}
\hfill\fbox{\dTy \subP{p}{e}}

\begin{align*}
\tvar{\alpha}{e'}\subP{p}{e} &= \tvar{\alpha}{e'\subP{p}{e}}\\
\tfun{x}{\dTy_x}{\dTy}\subP{p}{e} &= \tfun{x}{\dTy_x\subP{p}{e}}{\dTy\subP{p}{e}}\\
\tcon{\nhaskell{C}}{e'}{\listOf{\dTy}}{\listOf{e}}\subP{p}{e} 
	&= \tcon{\nhaskell{C}}{e'\subP{p}{e}}{\listOf{\dTy\subP{p}{e}}}{\listOf{e\subP{p}{e}}} \\
\tclass{\nhaskell{C}}{\listOf{\dTy}}\subP{p}{e} 
	&= \tclass{\nhaskell{C}}{\listOf{\dTy\subP{p}{e}}}\\
\tforallPr{P}{\dTy}\subP{p}{e} &=
	\left\{
		\begin{array}{ll}
		\tforallPr{P}{\dTy\subP{p}{e}}	& p \neq P \\
		\tforallPr{P}{\dTy}				& p = P 
		\end{array}
	\right. \\
\tforallTy{\alpha}{\dTy}\subP{p}{e} &=
		\tforallTy{\alpha}{\dTy\subP{p}{e}}\\
\end{align*}

%\subsection*{\hasTypeP{\penv}{e}{\pdTy}{C}}
\hfill\fbox{\hasTypeP{\penv}{e}{\pdTy}{C}}

$$
\inference{
	\pdTy = \penv(x) && \pdTy' = \pdinst{\pdTy}
}{
	\hasTypeP{\penv}{x}{\pdTy'}{\emptyset}
}[]
$$

$$
\inference{
}{
	\hasTypeP{\penv}{C}{ty(C)}{\emptyset}
}[]
$$

$$
\inference{
	\hasTypeP{\penv}{e_1}{\tfun{x}{\pdTy_x}{\pdTy_1}}{C_1} &
	\hasTypeP{\penv}{e_2}{\pdTy_2}{C_2}
}{
	\hasTypeP{\penv}{\eapp{e_1}{e_2}}{\pdTy_1}{ \{\pdTy_x :=: \pdTy_2 \} \cup C_1 \cup C_2}
}[]
$$

$$
\inference{
	\hasTypeP{\penv, x : \pdTy_x}{e}{\pdTy}{C}
}{
	\hasTypeP{\penv}{\elam{x}{e}}{\tfun{x}{\pdTy_x}{\pdTy}}{C}
}[]
$$
$$
\inference{
	\hasTypeP{\penv}{e}{\pdTy}{C}
}{
	\hasTypeP{\penv}{\epapp{e}}{\pdTy}{C}
}[]
$$
$$
\inference{
	\hasTypeP{\penv}{\eplam{p}{e}}{\pdTy}{C}
}{
	\hasTypeP{\penv}{\eplam{p}{e}}{\tforallPr{p}{\pdTy}}{C}
}[]
$$

$$
\inference{
	\hasTypeP{\penv}{e}{\tforallTy{\alpha}{\pdTy}}{C} & \pdTy_\alpha = \freshT{\tau}
}{
	\hasTypeP{\penv}{\etapp{e}{\tau}}{\pdTy \sub{\alpha}{\pdTy_\alpha}}{C}
}[]
$$

$$
\inference{
	\hasTypeP{\penv}{\etlam{\alpha}{e}}{\pdTy}{C} & \alpha \notin \penv
}{
	\hasTypeP{\penv}{\etlam{\alpha}{e}}{\tforallTy{a}{\pdTy}}{C}
}[]
$$

$$
\inference{
	\hasTypeP{\penv}{e}
		{\tcon{\nhaskell{C}}{e_c}{\listOf{\pdTy}}{\listOf{e}}}{C} \\
	\forall i . \{
		\hasTypeP{\penv}{\nhaskell{C}_i}{\pdTy_i}{C_i} && 
		    \pdinst{\pdTy_i} = 
			{\tforallTy{\listOf{\alpha}}{
				\tfun{y_1}{\pdTy_1}{
				\tfun{\dots y_j}{\pdTy_j}{
				\tfun{\dots y_n}{\pdTy_n}{
				\tcon{\nhaskell{C}}{e'_c}{\listOf{\dTy'}}{\listOf{e'}}}}			
			}}} \\			
		\hasTypeP{\penv, \listOf{x_{ij} : {\dTy_j \subT{\listOf{\alpha}}{\listOf{\pdTy}} }}}{e_i}{\pdTy_i}{C_i}	
	\}
}{
	\hasTypeP{\penv}{\ecase{e}{C_i \ \listOf{x_i}}{e_i}}{\pdTy}{\bigcup_{i}{\{ \pdTy_i :=: \pdTy \}} \bigcup_{i} C_i \cup C}
}[]
$$

$$
\inference{
	\hasTypeP{\penv}{e_1}{\pdTy_x}{C_x} & \generalizeP{C_x}{\pdTy_x}{\pdTy_x'} &
	\hasTypeP{\penv, x:\pdTy_x'}{e_2}{\pdTy}{C} &
}{
	\hasTypeP{\penv}{\elet{x}{e_1}{e_2}}{\pdTy}{C}
}[]
$$

$$
\inference{
	\hasTypeP{\penv}{e_1}{\pdTy_x}{C_x} & \generalizeP{C_x}{\pdTy_x}{\pdTy_x'} &
	\hasTypeP{\penv, x:\pdTy_x'}{e_2}{\pdTy}{C} &
}{
	\hasTypeP{\penv}{\eletrec{x}{e}{e}}{\pdTy}{C}
}[]
$$

%\subsection*{e \pdinst{\pdTy}}
\hfill\fbox{\pdinst{\pdTy}}

\begin{align*}
\pdinst{\tforallTy{\alpha}{\pdTy}} & = \tforallTy{\alpha}{\pdinst{\pdTy}}\\
\pdinst{\tforallPr{\listOf{P}}{\pdTy}} & = 
		\pdTy \subP{\listOf{P}}{\listOf{P'}} & \listOf{P'} \ \text{fresh} \\
\pdinst{\pdTy} & = \pdTy
\end{align*}

%\subsection*{e \pdgen{\pdTy}}
\hfill\fbox{\pdgen{\pdTy}}

\begin{align*}
\pdgen{\tforallTy{\alpha}{\pdTy}} & = \tforallTy{\alpha}{\pdinst{\pdTy}}\\
\pdgen{\pdTy} & = 
	\left\{
		\begin{array}{ll}
		\tforallPr{\listOf{P}}{\pdTy} & \listOf{P} \ \text{free in } \pdTy \\
		\dTy				 & \text{othewise} 
		\end{array}
	\right. \\
\end{align*}


%\subsection*{e \generalizeP{C}{\pdTy}{\pdTy}}
\hfill\fbox{\generalizeP{C}{\pdTy}{\pdTy}}

\generalizeP{C}{\pdTy}{\pdgen{\pdTy [ {\pdsplit{C}} ]}}


%\subsection*{e \pdsplit{C}}
\hfill\fbox{\pdsplit{C}}

\begin{align*}
\pdsplit{{\tvar{\alpha}{p} :=: \tvar{\alpha}{q}} , cs} &= \subP{p}{q}:\pdsplit{cs{\subP{p}{q}}}\\
\pdsplit{{\tfun{x_1}{\pdTy_{x_1}}{\pdTy_1} :=: \tfun{x_2}{\pdTy_{x_2}}{\pdTy_2}} , cs} &= 
	\pdsplit{(\pdTy_{x_1}:=:\pdTy_{x_2}):(\pdTy_1\sub{x_1}{x_2} :=: \pdTy_2):cs}\\
\pdsplit{{\tforallTy{\alpha_1}{\pdTy_1} :=: \tforallTy{\alpha_2}{\pdTy_2}} , cs} 
	&= \pdsplit{(\pdTy_1{\sub{\alpha_1}{\alpha_2}} :=: \pdTy_2):cs}\\
\pdsplit{{\tclass{\nhaskell{C}}{\listOf{\pdTy}} :=: \tclass{\nhaskell{C}}{\listOf{\pdTy}}} , cs} 
	&= \pdsplit{cs}\\
\pdsplit{	\tcon{\nhaskell{C}}{p_1}{\listOf{\pdTy_1}}{\listOf{p_1}} :=: 
		 	\tcon{\nhaskell{C}}{p_2}{\listOf{\pdTy_2}}{\listOf{p_2}} , cs} 
	&= \subP{\listOf{p_1}}{\listOf{p_2}} : \subP{p_1}{p_2}:\\
	&\pdsplit{ (\{ \listOf{\pdTy_1} :=: \listOf{\pdTy_2} \} \cup cs) {\subP{p_1}{p_2} o \subP{\listOf{p_1}}{\listOf{p_2}}}}\\
\end{align*}

\end{document}


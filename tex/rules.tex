\documentclass[10pt,a4paper]{article}
\usepackage[latin1]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{ngrammar}
\usepackage{ndisplay}
\usepackage{comment}
\usepackage[inference]{semantic}
\usepackage{liquidHaskell}
\usepackage{color}
\usepackage{textcomp}
\newcommand\highlight[2]{{\setlength\fboxsep{1pt}\colorbox{#1}{#2}}}
\def\NV{\highlight{colorNV}}
\definecolor{colorNV}{rgb}{1,0.8,1}

\begin{document}
\section*{Syntax}
%\subsection*{Types}
\begin{ngrammar}[noindent,notation=plain]

\nsdef{P}{%predicate
        \nst{\pdTrue}   %top
  \nsor \nst{\pdVar{p}{\tau}{\overline{x:\tau}}} 		%variable
  \nsor \nst{\pdAnd{P}{P}} 		%and
}

\nsdef{\parTy{T}{B}}{% pretype
	\nst{\tvar{\alpha}{\parAny{B}}} % TyVar
	\nsor \nst{\tfun
				{x}
				{\parTy{T}{B}}
				{\parTy{T}{B}}
			  } % FunTy Type Type
	\nsor \nst{\tcon
				{TyCon}
				{\parAny{B}}
				{\listOf{\parTy{T}{B}}}
				{\listOf{\parAny{B}}}
			  } %for Haskell's TyConApp
	\nsor \nst{\tclass
				{Class}
				{\listOf{\parTy{T}{B}}}
			  }	%Class
}

\nsdef{\parTy{P}{B}}{% 
	\nst{\tforallPr{P}{\parTy{P}{B}}} 
	\nsor \nst{\parTy{T}{B}}
}

\nsdef{\parTy{S}{B}}{%type
	\nst{\tforallTy{\alpha}{\parTy{S}{B}}} 
	\nsor \nst{\parTy{P}{B}}
}

\nsdef{\pdTy}{ % predicate Types
	\appTy{S}{P}
}

\nsdef{\lTy}{ % liquid Types
	\appTy{S}{Q}
}

\nsdef{\dTy}{ % dependent Types
	\appTy{S}{E}
}

\nsdef{$ \tau $}{ % haskell Types
	\appTy{S}{\pdTrue}
}

\nsdef{e}{ % expression
		  \nst{x}		%var
	\nsor \nst{C}		% dataCon
	\nsor \nst{\eapp{e}{e}}
	\nsor \nst{\elam{x}{e}}
	\nsorl \nst{\epapp{e}}
	\nsor \nst{\eplam{p}{e}}
	\nsor \nst{\etapp{e}{\tau}}
	\nsor \nst{\etlam{\alpha}{e}}
	\nsorl \nst{\ecase{x}{{C_i \ \listOf{x_i}}}{e_i}}
	\nsorl \nst{\elet{x}{e}{e}}
	\nsor \nst{\eletrec{x}{e}{e}}
}
\end{ngrammar}

\section*{Rules}
%\subsection*{hasType}

\hfill\fbox{\hasType{\Gamma}{P,Q}{e}{\dTy}}

$$
\inference{
	\hasType{\Gamma}{P,Q}{e}{\dTy_1} &
	\isSubType{\Gamma}{\dTy_1}{\dTy_2} &
	\isWellFormed{\Gamma}{\dTy_2}
}{
	\hasType{\Gamma}{P,Q}{e}{\dTy_2}
}[]
$$

$$
\inference{
	\Gamma(x) = \refa{v}{\dTy}{e}
}{
	\hasType{\Gamma}{P,Q}{x}{\refa{v}{\dTy}{e \land v = x}}
}[]
$$

$$
\inference{
}{
	\hasType{\Gamma}{P,Q}{\nhaskell{C}}{ty(c)}
}[]
$$

$$
\inference{
	\hasType{\Gamma}{P,Q}{e_1}{\tfun{x}{\dTy_x}{\dTy}} &
	\hasType{\Gamma}{P,Q}{e_2}{\dTy}
}{
	\hasType{\Gamma}{P,Q}{\eapp{e_1}{e_2}}{\dTy \sub{x}{e_2}}
}[]
$$

$$
\inference{
	\hasType{\Gamma, x:\lTy_x}{P,Q}{e}{\lTy} &
	\isWellFormed{\Gamma}{\tfun{x}{\lTy_x}{\lTy}}
}{
	\hasType{\Gamma}{P,Q}{\elam{x}{e}}{\tfun{x}{\lTy_x}{\lTy}}
}[]
$$


$$
\inference{
	\hasType{\Gamma}{P,Q}{e}{\tforallPr{p}{\dTy}} &
	e_p = \freshP{p} &
	\isWellFormedP{\Gamma}{p}{e_p}
}{
	\hasType{\Gamma}{P,Q}{\epapp{e}}{\dTy \subP{p}{e_p}}
}[]
$$
\NV{define : freshP}\\
\NV{do I need the following rule?}
$$
\inference{
	\hasType{\Gamma}{P,Q}{e}{\dTy} 
}{
	\hasType{\Gamma}{P,Q}{\eplam{p}{e}}{\tforallPr{p}{\dTy}}
}[]
$$

$$
\inference{
	\hasType{\Gamma}{P,Q}{e}{\tforallTy{\alpha}{\dTy}} &
	\lTy = \freshT{\tau}
}{
	\hasType{\Gamma}{P,Q}{\etapp{e}{\tau}}{\dTy \subT{\alpha}{\lTy}}
}[]
$$
\NV{define subT, freshT}

$$
\inference{
	\hasType{\Gamma}{P,Q}{e}{\dTy} &
	\alpha \notin \Gamma 
}{
	\hasType{\Gamma}{P,Q}{\etlam{\alpha}{e}}{\tforallTy{\alpha}{\dTy}}
}[]
$$

$$
\inference{
	\hasType{\Gamma}{P,Q}{e}
		{\tcon{\nhaskell{C}}{e_c}{\listOf{\dTy}}{\listOf{e}}} \\
	\forall i . \{
		\hasType{\Gamma}{P,Q}{\nhaskell{C}_i}
			{\tforallTy{\listOf{\alpha}}{\tforallPr{\listOf{p}}{
				\tfun{y_1}{\dTy_1}{
				\tfun{\dots y_j}{\dTy_j}{
				\tfun{\dots y_n}{\dTy_n}{
				\tcon{\nhaskell{C}}{e'_c}{\listOf{\dTy'}}{\listOf{e'}}}}}			
			}}} \\			
		\hasType{\Gamma, \listOf{x_{ij} : {\dTy_j \subT{\listOf{\alpha}}{\listOf{\dTy}}\subP{\listOf{p}}{\listOf{e}} }}}{P,Q}{e_i}{\dTy}	
	\}
}{
	\hasType{\Gamma}{P,Q}{\ecase{e}{C_i \ \listOf{x_i}}{e_i}}{\dTy}
}[]
$$

$$
\inference{
	\hasType{\Gamma}{P,Q}{e_1}{\dTy_x} &
	\unifyTypes{P(x)}{\dTy_x}{\dTy_x'} &
	\hasType{\Gamma,x:\dTy_x'}{P,Q}{e_2}{\dTy} &
}{
	\hasType{\Gamma}{P,Q}{\elet{x}{e_1}{e_2}}{\dTy}
}[]
$$
$$
\inference{
	\isWellFormed{\Gamma}{\lTy_x} &
	\hasType{\Gamma}{P,Q}{e_1}{\lTy_x} &
	\unifyTypes{P(x)}{\lTy_x}{\lTy_x'} &
	\hasType{\Gamma,x:\lTy_x'}{P,Q}{e_2}{\lTy} &
}{
	\hasType{\Gamma}{P,Q}{\eletrec{x}{e_1}{e_2}}{\lTy}
}[]
$$

%\subsection*{isSubType}
\hfill\fbox{\isSubType{\Gamma}{\dTy_1}{\dTy_2}}

$$
\inference{
	\valid{\inter{\Gamma} \land \inter{e_1}}{\inter{e_2}}
}{
	\isSubType{\Gamma}{\tvar{\alpha}{e_1}}{\tvar{\alpha}{e_2}}
}[]
$$

$$
\inference{
	\isSubType{\Gamma}{\dTy_{x_2}}{\dTy_{x_1}} &
	\isSubType{\Gamma, x_2:{\dTy_{x_2}}}{\dTy_1 \subT{x_1}{x_2}}{\dTy_2}	
}
{
	\isSubType{\Gamma}{\tfun{x_1}{\dTy_{x_1}}{\dTy_1}}{\tfun{x_2}{\dTy_{x_2}}{\dTy_2}}
}[]
$$

$$
\inference{
	\isSubType{\Gamma}{\dTy_1}{\dTy_2} 
}
{
	\isSubType{\Gamma}{\tforallTy{\alpha}{\dTy_1}}{\tforallTy{\alpha}{\dTy_2}}
}[]
$$

$$
\inference{
	\valid{\inter{\Gamma} \land \inter{e_1}}{\inter{e_2}} &
	\forall i. \isSubType{\Gamma}{\dTy_{1_i}}{\dTy_{2_i}} &
	\forall j. \valid{\inter{\Gamma} \land \inter{e_{1_j}}}{\inter{e_{2_j}}}
}
{
	\isSubType{\Gamma}
		{\tcon{\nhaskell{C}}{e_1}{\listOf{\dTy_1}}{\listOf{e_1}}}
		{\tcon{\nhaskell{C}}{e_2}{\listOf{\dTy_2}}{\listOf{e_2}}}
}[]
$$

\NV{no subtype for tforallPr!} \\
\NV{no subtype for tclass!}
%\tclass[2]
%\tforallPr[2]

%\subsection*{isWellFormed}
\hfill\fbox{\isWellFormed{\Gamma}{\dTy}}

$$
\inference{
	\hasType{\Gamma, v: \shape{\dTy}}{}{e}{\tbool} %normal typeinference
}{
	\isWellFormed{\Gamma}{\tvar{\alpha}{e}}
}[]
$$

$$
\inference{
	\isWellFormed{\Gamma}{\dTy_{x}} &
	\isWellFormed{\Gamma, x : \dTy_{x}}{\dTy}
}
{
	\isWellFormed{\Gamma}{\tfun{x}{\dTy_{x}}{\dTy}}
}[]
$$

$$
\inference{
	\isWellFormed{\Gamma}{\dTy} 
}
{
	\isWellFormed{\Gamma}{\tforallTy{\alpha}{\dTy}}
}[]
$$

\NV{define tyConP}

$$
\inference{
	\hasType{\Gamma, v: \shape{\dTy}}{}{e}{\tbool} & %normal typeinference
	\forall i. \isWellFormed{\Gamma}{\dTy_i} &
	\listOf{p} = \tyConPs{\nhaskell{C}} &
	\forall j. \isWellFormedP{\Gamma}{p_j}{e_j}
}
{
	\isWellFormed{\Gamma}
		{\tcon{\nhaskell{C}}{e}{\listOf{\dTy}}{\listOf{e}}}
}[]
$$

\NV{no subtype for tforallPr!} \\
\NV{no subtype for tclass!}
%\newcommand\tcon[4]{\ensuremath{\nhaskell{#1} ^{#2} \ #3 \ #4}}
%\newcommand\tforallPr[2]{\ensuremath{\forall #1 . #2}}

%\subsection*{isWellFormedP}
\hfill\fbox{\isWellFormedP{\Gamma}{p}{e}}

$$
\inference{
	\hasType{\Gamma, v:\tau, \overline{x:\tau}}{}{e}{\tbool}
}{
	\isWellFormedP{\Gamma}{\pdVar{p}{\tau}{\overline{x:\tau}}}{e}
}[]
$$

%\subsection*{unifyTypes}
\hfill\fbox{\unifyTypes{\pdTy}{\dTy}{\dTy}}

$$
\inference{
	\unifyTypes{\pdTy}{\dTy}{\dTy'}
}{
	\unifyTypes{\pdTy}{\tforallPr{p}{\dTy}}{\tforallPr{p}{\dTy'}}
}[]
$$


$$
\inference{
	\unifyTypes{\pdTy}{\dTy}{\dTy'}
}{
	\unifyTypes{\tforallPr{p}{\pdTy}}{\dTy}{\tforallPr{p}{\dTy'}}
}[]
$$

$$
\inference{
	\unifyTypes{{\pdTy \subT{\alpha}{\alpha'}}}{{\dTy}}{\dTy'}
}{
	\unifyTypes	{\tforallTy{\alpha}{\pdTy}}
				{\tforallTy{\alpha'}{\dTy}}
				{\tforallTy{\alpha'}{\dTy'}}
}[]
$$

$$
\inference{
	\unifyTypes	{\pdTy_x}{\dTy_{x'}}{\dTy_x'} &
	\unifyTypes	{\pdTy \sub{x}{x'}}{\dTy_{x'}}{\dTy'}
}{
	\unifyTypes	{\tfun{x}{{\pdTy_x}}{\pdTy}}
				{\tfun{x'}{\dTy_{x'}}{\dTy}}
				{\tfun{x'}{\dTy_x'}{\dTy'}}
}[]
$$

$$
\inference{
}{
	\unifyTypes	{\tclass{\nhaskell{C}}{\listOf{\pdTy}}}
				{\tclass{\nhaskell{C}}{\listOf{\dTy}}}
				{\tclass{\nhaskell{C}}{\listOf{\dTy}}}
}[]
$$
$$
\inference{
}{
	\unifyTypes	{\tvar{\alpha}{P}} 
				{\tvar{\alpha}{e}}
				{\tvar{\alpha}{e \land \pdapp{P}{v}}}
}[]
$$
$$
\inference{
	\forall i . {\unifyTypes{\pdTy_i}{\dTy_i}{\dTy_i'}}
}{
	\unifyTypes	{\tcon{\nhaskell{C}}{P}{\listOf{\pdTy}}{\listOf{P}}}
				{\tcon{\nhaskell{C}}{e}{\listOf{\dTy}}{\listOf{e}}}
				{\tcon	{\nhaskell{C}}
						{e \land \pdapp{P}{v}}{\listOf{\dTy'}}
						{\listOf{e_i \land \pdapp{P_i}{v}}}
				}
}[]
$$

%\subsection*{\isWellFormedP{\Gamma}{p}{e}}
\hfill\fbox{\isWellFormedP{\Gamma}{p}{e}}

$$
\inference{
	\hasType{\Gamma, v:\tau, \listOf{x:\tau}}{}{e}{\tbool}
}{
	\isWellFormedP{\Gamma}{\pdVar{p}{\tau}{\listOf{x:\tau}}}{e}
}[]
$$

$$
\inference{
	\hasType{\Gamma}{}{e}{\tbool}
}{
	\isWellFormedP{\Gamma}{\pdTrue}{e}
}[]
$$

$$
\inference{
	\isWellFormedP{\Gamma}{P_1}{e_1} &
	\isWellFormedP{\Gamma}{P_2}{e_2}
}{
	\isWellFormedP{\Gamma}{\pdAnd{P_1}{P_2}}{e_1 \land e_2}
}[]
$$

%\subsection*{e \subP{p}{e}}
\hfill\fbox{e \subP{p}{e}}

\begin{align*}
(e_1 \land e_2) \subP{p}{e} &= (e_1 \subP{p}{e}) \land (e_1 \subP{p}{e})\\
(\pdapp{p}{v, \subP{\listOf{x}}{\listOf{y}}}) \subP{p}{e} &= e\subP{\listOf{x}}{\listOf{y}} \\
(e') \subP{p}{e} &= e'
\end{align*}

%\subsection*{e \pdapp{P}{v}}
\hfill\fbox{\pdapp{P}{v}}

\begin{align*}
\pdapp{\pdTrue}{v} &= \pdTrue \\
\pdapp{\pdVar{p}{\tau}{\listOf{\tau}}}{v} &= p(v) \\
\pdapp{\pdAnd{P_1}{P_2}}{v} &= {\pdapp{P_1}{v}}{\pdapp{P_2}{v}}
\end{align*}

%\subsection*{\dTy \subP{p}{e}}
\hfill\fbox{\dTy \subP{p}{e}}

\begin{align*}
\tvar{\alpha}{e'}\subP{p}{e} &= \tvar{\alpha}{e'\subP{p}{e}}\\
\tfun{x}{\dTy_x}{\dTy}\subP{p}{e} &= \tfun{x}{\dTy_x\subP{p}{e}}{\dTy\subP{p}{e}}\\
\tcon{\nhaskell{C}}{e'}{\listOf{\dTy}}{\listOf{e}}\subP{p}{e} 
	&= \tcon{\nhaskell{C}}{e'\subP{p}{e}}{\listOf{\dTy\subP{p}{e}}}{\listOf{e\subP{p}{e}}} \\
\tclass{\nhaskell{C}}{\listOf{\dTy}}\subP{p}{e} 
	&= \tclass{\nhaskell{C}}{\listOf{\dTy\subP{p}{e}}}\\
\tforallPr{P}{\dTy}\subP{p}{e} &=
	\left\{
		\begin{array}{ll}
		\tforallPr{P}{\dTy\subP{p}{e}}	& p \neq P \\
		\tforallPr{P}{\dTy}				& p = P 
		\end{array}
	\right. \\
\tforallTy{\alpha}{\dTy}\subP{p}{e} &=
		\tforallTy{\alpha}{\dTy\subP{p}{e}}\\
\end{align*}

%\subsection*{\hasTypeP{\penv}{e}{\pdTy}{C}}
\hfill\fbox{\hasTypeP{\penv}{e}{\pdTy}{C}}

$$
\inference{
	\pdTy = \penv(x) && \pdTy' = \pdinst{\pdTy}
}{
	\hasTypeP{\penv}{x}{\pdTy'}{\emptyset}
}[]
$$

$$
\inference{
}{
	\hasTypeP{\penv}{C}{ty(C)}{\emptyset}
}[]
$$

$$
\inference{
	\hasTypeP{\penv}{e_1}{\tfun{x}{\pdTy_x}{\pdTy_1}}{C_1} &
	\hasTypeP{\penv}{e_2}{\pdTy_2}{C_2}
}{
	\hasTypeP{\penv}{\eapp{e_1}{e_2}}{\pdTy_1}{ \{\pdTy_x :=: \pdTy_2 \} \cup C_1 \cup C_2}
}[]
$$

$$
\inference{
	\hasTypeP{\penv, x : \pdTy_x}{e}{\pdTy}{C}
}{
	\hasTypeP{\penv}{\elam{x}{e}}{\tfun{x}{\pdTy_x}{\pdTy}}{C}
}[]
$$
$$
\inference{
	\hasTypeP{\penv}{e}{\pdTy}{C}
}{
	\hasTypeP{\penv}{\epapp{e}}{\pdTy}{C}
}[]
$$
$$
\inference{
	\hasTypeP{\penv}{\eplam{p}{e}}{\pdTy}{C}
}{
	\hasTypeP{\penv}{\eplam{p}{e}}{\tforallPr{p}{\pdTy}}{C}
}[]
$$

$$
\inference{
	\hasTypeP{\penv}{e}{\tforallTy{\alpha}{\pdTy}}{C} & \pdTy_\alpha = \freshT{\tau}
}{
	\hasTypeP{\penv}{\etapp{e}{\tau}}{\pdTy \sub{\alpha}{\pdTy_\alpha}}{C}
}[]
$$

$$
\inference{
	\hasTypeP{\penv}{\etlam{\alpha}{e}}{\pdTy}{C} & \alpha \notin \penv
}{
	\hasTypeP{\penv}{\etlam{\alpha}{e}}{\tforallTy{a}{\pdTy}}{C}
}[]
$$

$$
\inference{
	\hasTypeP{\penv}{e}
		{\tcon{\nhaskell{C}}{e_c}{\listOf{\pdTy}}{\listOf{e}}}{C} \\
	\forall i . \{
		\hasTypeP{\penv}{\nhaskell{C}_i}{\pdTy_i}{C_i} && 
		    \pdinst{\pdTy_i} = 
			{\tforallTy{\listOf{\alpha}}{
				\tfun{y_1}{\pdTy_1}{
				\tfun{\dots y_j}{\pdTy_j}{
				\tfun{\dots y_n}{\pdTy_n}{
				\tcon{\nhaskell{C}}{e'_c}{\listOf{\dTy'}}{\listOf{e'}}}}			
			}}} \\			
		\hasTypeP{\penv, \listOf{x_{ij} : {\dTy_j \subT{\listOf{\alpha}}{\listOf{\pdTy}} }}}{e_i}{\pdTy_i}{C_i}	
	\}
}{
	\hasTypeP{\penv}{\ecase{e}{C_i \ \listOf{x_i}}{e_i}}{\pdTy}{\bigcup_{i}{\{ \pdTy_i :=: \pdTy \}} \bigcup_{i} C_i \cup C}
}[]
$$

$$
\inference{
	\hasTypeP{\penv}{e_1}{\pdTy_x}{C_x} & \generalizeP{C_x}{\pdTy_x}{\pdTy_x'} &
	\hasTypeP{\penv, x:\pdTy_x'}{e_2}{\pdTy}{C} &
}{
	\hasTypeP{\penv}{\elet{x}{e_1}{e_2}}{\pdTy}{C}
}[]
$$

$$
\inference{
	\hasTypeP{\penv}{e_1}{\pdTy_x}{C_x} & \generalizeP{C_x}{\pdTy_x}{\pdTy_x'} &
	\hasTypeP{\penv, x:\pdTy_x'}{e_2}{\pdTy}{C} &
}{
	\hasTypeP{\penv}{\eletrec{x}{e}{e}}{\pdTy}{C}
}[]
$$

%\subsection*{e \pdinst{\pdTy}}
\hfill\fbox{\pdinst{\pdTy}}

\begin{align*}
\pdinst{\tforallTy{\alpha}{\pdTy}} & = \tforallTy{\alpha}{\pdinst{\pdTy}}\\
\pdinst{\tforallPr{\listOf{P}}{\pdTy}} & = 
		\pdTy \subP{\listOf{P}}{\listOf{P'}} & \listOf{P'} \ \text{fresh} \\
\pdinst{\pdTy} & = \pdTy
\end{align*}

%\subsection*{e \pdgen{\pdTy}}
\hfill\fbox{\pdgen{\pdTy}}

\begin{align*}
\pdgen{\tforallTy{\alpha}{\pdTy}} & = \tforallTy{\alpha}{\pdinst{\pdTy}}\\
\pdgen{\pdTy} & = 
	\left\{
		\begin{array}{ll}
		\tforallPr{\listOf{P}}{\pdTy} & \listOf{P} \ \text{free in } \pdTy \\
		\dTy				 & \text{othewise} 
		\end{array}
	\right. \\
\end{align*}


%\subsection*{e \generalizeP{C}{\pdTy}{\pdTy}}
\hfill\fbox{\generalizeP{C}{\pdTy}{\pdTy}}

\generalizeP{C}{\pdTy}{\pdgen{\pdTy [ {\pdsplit{C}} ]}}


%\subsection*{e \pdsplit{C}}
\hfill\fbox{\pdsplit{C}}

\begin{align*}
\pdsplit{{\tvar{\alpha}{p} :=: \tvar{\alpha}{q}} , cs} &= \subP{p}{q}:\pdsplit{cs{\subP{p}{q}}}\\
\pdsplit{{\tfun{x_1}{\pdTy_{x_1}}{\pdTy_1} :=: \tfun{x_2}{\pdTy_{x_2}}{\pdTy_2}} , cs} &= 
	\pdsplit{(\pdTy_{x_1}:=:\pdTy_{x_2}):(\pdTy_1\sub{x_1}{x_2} :=: \pdTy_2):cs}\\
\pdsplit{{\tforallTy{\alpha_1}{\pdTy_1} :=: \tforallTy{\alpha_2}{\pdTy_2}} , cs} 
	&= \pdsplit{(\pdTy_1{\sub{\alpha_1}{\alpha_2}} :=: \pdTy_2):cs}\\
\pdsplit{{\tclass{\nhaskell{C}}{\listOf{\pdTy}} :=: \tclass{\nhaskell{C}}{\listOf{\pdTy}}} , cs} 
	&= \pdsplit{cs}\\
\pdsplit{	\tcon{\nhaskell{C}}{p_1}{\listOf{\pdTy_1}}{\listOf{p_1}} :=: 
		 	\tcon{\nhaskell{C}}{p_2}{\listOf{\pdTy_2}}{\listOf{p_2}} , cs} 
	&= \subP{\listOf{p_1}}{\listOf{p_2}} : \subP{p_1}{p_2}:\\
	&\pdsplit{ (\{ \listOf{\pdTy_1} :=: \listOf{\pdTy_2} \} \cup cs) {\subP{p_1}{p_2} o \subP{\listOf{p_1}}{\listOf{p_2}}}}\\
\end{align*}

\end{document}


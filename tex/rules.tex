\documentclass[10pt,a4paper]{article}
\usepackage[latin1]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{ngrammar}
\usepackage{ndisplay}
\usepackage{comment}
\usepackage[inference]{semantic}
\usepackage{liquidHaskell}
\usepackage{color}
\usepackage{textcomp}
\newcommand\highlight[2]{{\setlength\fboxsep{1pt}\colorbox{#1}{#2}}}
\def\NV{\highlight{colorNV}}
\definecolor{colorNV}{rgb}{1,0.8,1}

\begin{document}
\section*{Syntax}
\subsection*{Types}
\begin{ngrammar}[noindent,notation=plain]

\nsdef{P}{%predicate
        \nst{\pdTrue}   %top
  \nsor \nst{\pdVar{p}{\tau}{\overline{x:\tau}}} 		%variable
  \nsor \nst{\pdAnd{P}{P}} 		%and
}

\nsdef{\parTy{T}{B}}{% pretype
	\nst{\tvar{\alpha}{\parAny{B}}} % TyVar
	\nsor \nst{\tfun
				{x}
				{\parTy{T}{B}}
				{\parTy{T}{B}}
			  } % FunTy Type Type
	\nsor \nst{\tcon
				{TyCon}
				{\parAny{B}}
				{\listOf{\parTy{T}{B}}}
				{\listOf{\parAny{B}}}
			  } %for Haskell's TyConApp
	\nsor \nst{\tclass
				{Class}
				{\listOf{\parTy{T}{B}}}
			  }	%Class
}

\nsdef{\parTy{P}{B}}{% 
	\nst{\tforallPr{P}{\parTy{P}{B}}} 
	\nsor \nst{\parTy{T}{B}}
}

\nsdef{\parTy{S}{B}}{%type
	\nst{\tforallTy{\alpha}{\parTy{S}{B}}} 
	\nsor \nst{\parTy{P}{B}}
}

\nsdef{\pdTy}{ % predicate Types
	\appTy{S}{P}
}

\nsdef{\lTy}{ % liquid Types
	\appTy{S}{Q}
}

\nsdef{\dTy}{ % dependent Types
	\appTy{S}{E}
}

\nsdef{$ \tau $}{ % haskell Types
	\appTy{S}{\pdTrue}
}

\nsdef{e}{ % expression
		  \nst{x}		%var
	\nsor \nst{C}		% dataCon
	\nsor \nst{\eapp{e}{e}}
	\nsor \nst{\elam{x}{e}}
	\nsorl \nst{\epapp{e}}
	\nsor \nst{\eplam{p}{e}}
	\nsor \nst{\etapp{e}{\tau}}
	\nsor \nst{\etlam{\alpha}{e}}
	\nsorl \nst{\ecase{x}{{C_i \ \listOf{x_i}}}{e_i}}
	\nsorl \nst{\elet{x}{e}{e}}
	\nsor \nst{\eletrec{x}{e}{e}}
}
\end{ngrammar}

\section*{Rules}
%\subsection*{hasType}

\hfill\fbox{\hasType{\Gamma}{P,Q}{e}{\dTy}}

$$
\inference{
	\hasType{\Gamma}{P,Q}{e}{\dTy_1} &
	\isSubType{\Gamma}{\dTy_1}{\dTy_2} &
	\isWellFormed{\Gamma}{\dTy_2}
}{
	\hasType{\Gamma}{P,Q}{e}{\dTy_2}
}[]
$$

$$
\inference{
	\Gamma(x) = \refa{v}{\dTy}{e}
}{
	\hasType{\Gamma}{P,Q}{x}{\refa{v}{\dTy}{e \land v = x}}
}[]
$$

$$
\inference{
}{
	\hasType{\Gamma}{P,Q}{\nhaskell{C}}{ty(c)}
}[]
$$

$$
\inference{
	\hasType{\Gamma}{P,Q}{e_1}{\tfun{x}{\dTy_x}{\dTy}} &
	\hasType{\Gamma}{P,Q}{e_2}{\dTy}
}{
	\hasType{\Gamma}{P,Q}{\eapp{e_1}{e_2}}{\dTy \sub{x}{e_2}}
}[]
$$

$$
\inference{
	\hasType{\Gamma, x:\lTy_x}{P,Q}{e}{\lTy} &
	\isWellFormed{\Gamma}{\tfun{x}{\lTy_x}{\lTy}}
}{
	\hasType{\Gamma}{P,Q}{\elam{x}{e}}{\tfun{x}{\lTy_x}{\lTy}}
}[]
$$


$$
\inference{
	\hasType{\Gamma}{P,Q}{e}{\tforallPr{p}{\dTy}} &
	e_p = \freshP{p} &
	\isWellFormedP{\Gamma}{p}{e_p}
}{
	\hasType{\Gamma}{P,Q}{\epapp{e}}{\dTy \subP{p}{e_p}}
}[]
$$
\NV{define : freshP, subP}\\
\NV{do I need the following rule?}
$$
\inference{
	\hasType{\Gamma}{P,Q}{e}{\dTy} 
}{
	\hasType{\Gamma}{P,Q}{\eplam{p}{e}}{\tforallPr{p}{\dTy}}
}[]
$$

$$
\inference{
	\hasType{\Gamma}{P,Q}{e}{\tforallTy{\alpha}{\dTy}} &
	\lTy = \freshT{\tau}
}{
	\hasType{\Gamma}{P,Q}{\etapp{e}{\tau}}{\dTy \subT{\alpha}{\lTy}}
}[]
$$
\NV{define subT, freshT}

$$
\inference{
	\hasType{\Gamma}{P,Q}{e}{\dTy} &
	\alpha \notin \Gamma 
}{
	\hasType{\Gamma}{P,Q}{\etlam{\alpha}{e}}{\tforallTy{\alpha}{\dTy}}
}[]
$$

$$
\inference{
	\hasType{\Gamma}{P,Q}{e}
		{\tcon{\nhaskell{C}}{e_c}{\listOf{\dTy}}{\listOf{e}}} \\
	\forall i . \{
		\hasType{\Gamma}{P,Q}{\nhaskell{C}_i}
			{\tforallTy{\listOf{\alpha}}{\tforallPr{\listOf{p}}{
				\tfun{y_1}{\dTy_1}{
				\tfun{\dots y_j}{\dTy_j}{
				\tfun{\dots y_n}{\dTy_n}{
				\tcon{\nhaskell{C}}{e'_c}{\listOf{\dTy'}}{\listOf{e'}}}}}			
			}}} \\			
		\hasType{\Gamma, \listOf{x_{ij} : {\dTy_j \subT{\listOf{\alpha}}{\listOf{\dTy}}\subP{\listOf{p}}{\listOf{e}} }}}{P,Q}{e_i}{\dTy}	
	\}
}{
	\hasType{\Gamma}{P,Q}{\ecase{e}{C_i \ \listOf{x_i}}{e_i}}{\dTy}
}[]
$$

\NV{define unifyTypes}
$$
\inference{
	\hasType{\Gamma}{P,Q}{e_1}{\dTy_x} &
	\unifyTypes{P(x)}{\dTy_x}{\dTy_x'} &
	\hasType{\Gamma,x:\dTy_x'}{P,Q}{e_2}{\dTy} &
}{
	\hasType{\Gamma}{P,Q}{\elet{x}{e_1}{e_2}}{\dTy}
}[]
$$
$$
\inference{
	\isWellFormed{\Gamma}{\lTy_x} &
	\hasType{\Gamma}{P,Q}{e_1}{\lTy_x} &
	\unifyTypes{P(x)}{\lTy_x}{\lTy_x'} &
	\hasType{\Gamma,x:\lTy_x'}{P,Q}{e_2}{\lTy} &
}{
	\hasType{\Gamma}{P,Q}{\eletrec{x}{e_1}{e_2}}{\lTy}
}[]
$$

%\subsection*{isSubType}
\hfill\fbox{\isSubType{\Gamma}{\dTy_1}{\dTy_2}}

$$
\inference{
	\valid{\inter{\Gamma} \land \inter{e_1}}{\inter{e_2}}
}{
	\isSubType{\Gamma}{\tvar{\alpha}{e_1}}{\tvar{\alpha}{e_2}}
}[]
$$

$$
\inference{
	\isSubType{\Gamma}{\dTy_{x_2}}{\dTy_{x_1}} &
	\isSubType{\Gamma, x_2:{\dTy_{x_2}}}{\dTy_1 \subT{x_1}{x_2}}{\dTy_2}	
}
{
	\isSubType{\Gamma}{\tfun{x_1}{\dTy_{x_1}}{\dTy_1}}{\tfun{x_2}{\dTy_{x_2}}{\dTy_2}}
}[]
$$

$$
\inference{
	\isSubType{\Gamma}{\dTy_1}{\dTy_2} 
}
{
	\isSubType{\Gamma}{\tforallTy{\alpha}{\dTy_1}}{\tforallTy{\alpha}{\dTy_2}}
}[]
$$

$$
\inference{
	\valid{\inter{\Gamma} \land \inter{e_1}}{\inter{e_2}} &
	\forall i. \isSubType{\Gamma}{\dTy_{1_i}}{\dTy_{2_i}} &
	\forall j. \valid{\inter{\Gamma} \land \inter{e_{1_j}}}{\inter{e_{2_j}}}
}
{
	\isSubType{\Gamma}
		{\tcon{\nhaskell{C}}{e_1}{\listOf{\dTy_1}}{\listOf{e_1}}}
		{\tcon{\nhaskell{C}}{e_2}{\listOf{\dTy_2}}{\listOf{e_2}}}
}[]
$$

\NV{no subtype for tforallPr!} \\
\NV{no subtype for tclass!}
%\tclass[2]
%\tforallPr[2]

%\subsection*{isWellFormed}
\hfill\fbox{\isWellFormed{\Gamma}{\dTy}}

$$
\inference{
	\hasType{\Gamma, v: \shape{\dTy}}{}{e}{\tbool} %normal typeinference
}{
	\isWellFormed{\Gamma}{\tvar{\alpha}{e}}
}[]
$$

$$
\inference{
	\isWellFormed{\Gamma}{\dTy_{x}} &
	\isWellFormed{\Gamma, x : \dTy_{x}}{\dTy}
}
{
	\isWellFormed{\Gamma}{\tfun{x}{\dTy_{x}}{\dTy}}
}[]
$$

$$
\inference{
	\isWellFormed{\Gamma}{\dTy} 
}
{
	\isWellFormed{\Gamma}{\tforallTy{\alpha}{\dTy}}
}[]
$$

\NV{define tyConP}

$$
\inference{
	\hasType{\Gamma, v: \shape{\dTy}}{}{e}{\tbool} & %normal typeinference
	\forall i. \isWellFormed{\Gamma}{\dTy_i} &
	\listOf{p} = \tyConPs{\nhaskell{C}} &
	\forall j. \isWellFormedP{\Gamma}{p_j}{e_j}
}
{
	\isWellFormed{\Gamma}
		{\tcon{\nhaskell{C}}{e}{\listOf{\dTy}}{\listOf{e}}}
}[]
$$

\NV{no subtype for tforallPr!} \\
\NV{no subtype for tclass!}
%\newcommand\tcon[4]{\ensuremath{\nhaskell{#1} ^{#2} \ #3 \ #4}}
%\newcommand\tforallPr[2]{\ensuremath{\forall #1 . #2}}

%\subsection*{isWellFormedP}
\hfill\fbox{\isWellFormedP{\Gamma}{p}{e}}

$$
\inference{
	\hasType{\Gamma, v:\tau, \overline{x:\tau}}{}{e}{\tbool}
}{
	\isWellFormedP{\Gamma}{\pdVar{p}{\tau}{\overline{x:\tau}}}{e}
}[]
$$


\end{document}


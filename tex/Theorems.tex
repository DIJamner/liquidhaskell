\documentclass[10pt,a4paper]{article}
\usepackage[latin1]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{ngrammar}
\usepackage{ndisplay}
\usepackage{comment}
\usepackage[inference]{semantic}
\usepackage{color}
\usepackage{textcomp}
\newcommand\highlight[2]{{\setlength\fboxsep{1pt}\colorbox{#1}{#2}}}
\def\NV{\highlight{colorNV}}
\definecolor{colorNV}{rgb}{1,0.8,1}

\usepackage{amsthm}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newtheorem{definition}{Definition}
\newtheorem*{proofIdea}{ProofIdea}

%basic
\newcommand\vref{\ensuremath{v}}

%types
\newcommand\tref[2]{\ensuremath{\left\lbrace \vref : #1\mid #2\right\rbrace}}
\newcommand\tbint{\ensuremath{\texttt{int}}}
\newcommand\tbbool{\ensuremath{\texttt{bool}}}
\newcommand\tc[1]{\ensuremath{tc\left(\texttt{#1}\right)}}
\newcommand\tfun[3]{\ensuremath{#1 : #2 \rightarrow #3}}
\newcommand\tpabs[3]{\ensuremath{\forall #1 : #2 . #3}}
\newcommand\ttabs[2]{\ensuremath{\forall #1 . #2}}

%expressions
\newcommand\etabs[2]{\ensuremath{\forall #1 . #2}}
\newcommand\epabs[3]{\ensuremath{\forall #1 : #2 . #3}}
\newcommand\efun[2]{\ensuremath{\lambda #1 . #2}}
\newcommand\eapp[2]{\ensuremath{{#1} \ {#2}}}
\newcommand\etapp[2]{\ensuremath{{#1} \left[ {#2}\right]}}
\newcommand\epapp[1]{\ensuremath{{#1} \ @}}

%rule names
\newcommand\tapp{\rulename{T-App}}
\newcommand\tsub{\rulename{T-Sub}}
\newcommand\tcon{\rulename{T-Con}}
\newcommand\tinst{\rulename{T-Inst}}
\newcommand\tgen{\rulename{T-Gen}}
\newcommand\tpinst{\rulename{T-PInst}}
\newcommand\tpgen{\rulename{T-PGen}}

\newcommand\wsEmp{\rulename{WS-Empty}}
\newcommand\wsExt{\rulename{WS-Ext}}
\newcommand\wsGxt{\rulename{WS-Gxt}}

\newcommand\wstEmp{\rulename{WTS-Empty}}
\newcommand\wstExt{\rulename{WTS-Ext}}
\newcommand\wstGxt{\rulename{WTS-Gxt}}


\newcommand\isWellFormed[2]{\ensuremath{{#1}\models {#2}}}
\newcommand\isSub[3]{\ensuremath{{#1}\vdash {#2}<:{#3}}}
\newcommand\hastype[3]{\ensuremath{{#1}\vdash {#2}:{#3}}}
\newcommand\eval[2]{\ensuremath{{#1}\hookrightarrow {#2}}}

\newcommand\hastypeEmp[2]{\hastype{\emptyset}{#1}{#2}}
\newcommand\isSubEmp[2]{\isSub{\emptyset}{#1}{#2}}

\newcommand\rulename[1]{\textsc{#1}}
\newcommand\sch[1]{\ensuremath{\texttt{Schema}\left(#1\right)}}
\newcommand\fv[1]{\ensuremath{\texttt{FreeVars}\left(#1\right)}}
\newcommand\sub[2]{\ensuremath{\left[ #1 \mapsto #2 \right]}}

\begin{document}
\NV{missing:}\\
\NV{* Proofs for Lemmata}\\
\NV{* expr let where unification takes place}\\
\NV{* data cons}\\
\NV{* type classes?}\\

\section*{Grammar}
\begin{ngrammar}[noindent,notation=plain]

\nsdef{e}{%expressions
        \nst{x}   						%var
  \nsor \nst{c} 							%constant
  \nsor \nst{\efun{x}{e}} 				%abs
  \nsor \nst{\eapp{e}{e}} 				%application
  \nsor \nst{\epabs{p}{\tau}{e}} 		%predicate abs
  \nsor \nst{\epapp{e}} 					%predicate abs
  \nsor \nst{\etabs{\alpha}{e}}			%type abs
  \nsor \nst{\etapp{e}{\tau}} 			%type application
}

\nsdef{B}{%basic types
        		\nst{\tbint}   						%int
  	\nsor 	\nst{\tbbool} 						%bool
  	\nsor 	\nst{$\alpha$} 						%type var
}

\nsdef{T}{%types
			\nst{\tref{B}{e}}
	\nsor	\nst{\tfun{x}{T}{T}}
}

\nsdef{P}{%types with preds
			\nst{T}
	\nsor	\nst{\tpabs{p}{\tau}{P}}
}

\nsdef{S}{%types with polymorhism
			\nst{P}
	\nsor	\nst{\ttabs{\alpha}{S}}
}

\nsdef{v}{%values
        \nst{x}   						%var
  \nsor \nst{c} 							%constant
  \nsor \nst{\efun{x}{e}} 				%predicate abs
  \nsor \nst{\epabs{p}{\tau}{v}} 		%predicate abs
  \nsor \nst{\etabs{\alpha}{v}}			%type abs
}
\end{ngrammar}

\section*{Operational Semantics}
\hfill\fbox{\eval{e}{e}}

$$
\inference{
	\eval{e_1}{e_1'}
}{
	\eval{\eapp{e_1}{e_2}}{\eapp{e_1'}{e_2}}
}[\rulename{S-PAppL}]
$$

$$
\inference{
	\eval{e_2}{e_2'}
}{
	\eval{\eapp{v}{e_2}}{\eapp{v}{e_2'}}
}[\rulename{S-PAppR}]
$$

$$
\inference{
	\eval{e}{e'}
}{
	\eval{\etapp{e}{\tau}}{\etapp{e'}{\tau}}
}[\rulename{S-PType-App}]
$$
$$
\inference{
	\eval{e}{e'}
}{
	\eval{\epapp{e}}{\epapp{e'}}
}[\rulename{S-PPred-App}]
$$

$$
\inference{
}{
	\eval{\eapp{\efun{x}{e}}{v}}{e\sub{x}{v}}
}[\rulename{S-EApp}]
$$

$$
\inference{
}{
	\eval{\eapp{c}{v}}{[|c|](v)}
}[\rulename{S-EApp-Con}]
$$

$$
\inference{
}{
	\eval{\epapp{(\epabs{p}{\tau}{v})}}{v}
}[\rulename{S-EPred-App}]
$$

\NV{are the following two rules valid?}
$$
\inference{
}{
	\eval{\epapp{c}}{\epapp{[|c|]}}
}[\rulename{S-EPApp-Con}]
$$

$$
\inference{
}{
	\eval{\etapp{c}{\tau}}{\etapp{[|c|]}{\tau}}
}[\rulename{S-ETApp-Con}]
$$

$$
\inference{
}{
	\eval{\etapp{(\etabs{\alpha}{v})}{\tau}}{v\sub{\alpha}{\tau}}
}[\rulename{S-EType-App}]
$$


\section*{Rules}
%\subsection*{Typing}
\hfill\fbox{\hastype{\Gamma}{e}{S}}

$$
\inference{
	\hastype{\Gamma}{e}{S_2} && \isSub{\Gamma}{S_2}{S_1}
}{
	\hastype{\Gamma}{e}{S_1}
}[\tsub]
$$

$$
\inference{
	\Gamma(x) = \tref{B}{e}
}{
	\hastype{\Gamma}{x}{\tref{B}{e \land \vref = x}}
}[\rulename{T-Var-Base}]
$$

$$
\inference{
	\Gamma(x) \neq \tref{B}{e}
}{
	\hastype{\Gamma}{x}{\Gamma(x)}
}[\rulename{T-Var}]
$$

$$
\inference{
}{
	\hastype{\Gamma}{c}{\tc{c}}
}[\tcon]
$$

$$
\inference{
	\hastype{\Gamma, x : T_x}{e}{T} && \isWellFormed{\Gamma}{\tfun{x}{T_x}{T}}
}{
	\hastype{\Gamma}{\efun{x}{e}}{\tfun{x}{T_x}{T}}
}[\rulename{T-Fun}]
$$

$$\label{tapp}
\inference{
	\hastype{\Gamma}{e_1}{\tfun{x}{T_x}{T}} && 
	\hastype{\Gamma}{e_2}{T_x}
}{
	\hastype{\Gamma}{\eapp{e_1}{e_2}}{T\sub{x}{e_1}}
}[\tapp]
$$

$$
\inference{
	\hastype{\Gamma, p:T_p}{e}{S} && 
	\sch{T_p} = \tau \rightarrow \tbbool &&
	p \notin \fv{e}
}{
	\hastype{\Gamma}{\epabs{p}{\tau}{e}}{\tpabs{p}{\tau}{S}}
}[\tpgen]
$$

$$
\inference{
	\hastype{\Gamma}{e}{\tpabs{p}{\tau}{S}} && 
	\hastype{\Gamma}{v}{T} && \sch{T} = \tau \rightarrow \tbbool &&
	\isWellFormed{\Gamma}{T}
}{
	\hastype{\Gamma}{\epapp{e}}{S\sub{p}{v}}
}[\tpinst]
$$

$$
\inference{
	\hastype{\Gamma}{e}{S} && 
	\alpha \notin \Gamma
}{
	\hastype{\Gamma}{\etabs{\alpha}{e}}{\ttabs{\alpha}{S}}
}[\tgen]
$$

$$
\inference{
	\hastype{\Gamma}{e}{\ttabs{\alpha}{S}} && 
	\sch{T} = \tau && \isWellFormed{\Gamma}{T}
}{
	\hastype{\Gamma}{\etapp{e}{\tau}}{S\sub{\alpha}{T}}
}[\tinst]
$$

%\subsection*{WF sub}
\hfill\fbox{\isWellFormed{\Gamma}{\rho}}

$$
\inference{
}{
	\isWellFormed{\emptyset}{\emptyset}
}[\wsEmp]
$$

$$
\inference{
	\isWellFormed{\Gamma}{\rho} && \hastypeEmp{v}{\rho S}
}{
	\isWellFormed{\Gamma; x:S}{\rho ; \sub{x}{v}}
}[\wsExt]
$$



\begin{comment}
$$
\inference{
	\isWellFormed{\Gamma}{\rho} && \evalstar{\rho e}{true}
}{
	\isWellFormed{\Gamma; e}{\rho}
}[\wsGxt]
$$
\end{comment}


%\subsection*{WF type sub}

\NV{define type sub, \sch{T} = $\tau$, sub $\tau$ on exprs and T on types}\\
\hfill\fbox{\isWellFormed{\Gamma}{\theta}}

$$
\inference{
}{
	\isWellFormed{\emptyset}{\emptyset}
}[\wstEmp]
$$

$$
\inference{
	\isWellFormed{\Gamma}{\theta} && \isWellFormed{\emptyset}{\theta S}
}{
	\isWellFormed{\Gamma}{\theta;\sub{a}{S}}
}[\wstExt]
$$


\section*{Proves}

\begin{definition}[Constants]
\label{DefConstants}
Each constant $c$ has type \tc{c}, such that
\begin{enumerate}
\item \hastypeEmp{c}{\tc{c}}
\item if $\tc{c} \equiv \tfun{x}{T_x}{T}$
	  then for all values $v \in T_x$, 
	  $[|c|](v)$ is defined and 
	  \hastypeEmp{[|c|](v)}{T\sub{x}{v}}.
\item if $\tc{c} \equiv \ttabs{\alpha}{S}$
	  then for all types $\tau$, 
	  if for some $T$, then 
	  $\sch{T} = \tau$ and \isWellFormed{\emptyset}{T}, 
	  $\etapp{[|c|]}{\tau}$ is defined and 
	  \hastypeEmp{\etapp{[|c|]}{\tau}}{S\sub{\alpha}{T}}.
\item if $\tc{c} \equiv \tpabs{p}{\tau}{S}$
	  then for all values $v$, 
	  if \hastypeEmp{v}{T}, where $\sch{T} = \tau \rightarrow \tbbool$ 
	  and \isWellFormed{\emptyset}{T}, 
	  $\epapp{[|c|]}$ is defined and 
	  \hastypeEmp{\epapp{[|c|]}}{S\sub{p}{v}}.
%\item If \tc{c} is \tref{B}{e} then $e \equiv \vref = c $
\end{enumerate}
\end{definition}

\begin{lemma}
\label{LemEvalSub}
If \eval{e}{e'} 
and \hastypeEmp{e}{S_e}
and \hastypeEmp{e'}{S_e}
then \isSub{\Gamma}{S\sub{x}{e'}}{S\sub{x}{e}}
\end{lemma}
\begin{proofIdea}
$[| \star|]$ is defined to preserve operational semantics
\end{proofIdea}


\begin{lemma}[Value Substitution]
\label{LemValueSub}
If \isWellFormed{\Gamma}{\rho} 
then if \hastype{\Gamma; \Gamma'}{e}{S}
then \hastype{\rho\Gamma'}{\rho e}{\rho S}
\end{lemma}
\begin{proofIdea}
Pat-Ming Lemma 10
\end{proofIdea}

\begin{lemma}[Type Substitution]
\label{LemTypeSub}
If \isWellFormed{\Gamma}{\theta} 
then if \hastype{\Gamma; \Gamma'}{e}{S}
then \hastype{\rho\Gamma'}{\theta e}{\theta S}
\end{lemma}
\begin{proofIdea}
???
\end{proofIdea}


\include{preservation}
\include{progress}

\include{soundness}

\end{document}